<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CSV è³‡æ–™åœ–è¡¨é¡¯ç¤º</title>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 30px;
            text-align: center;
            position: relative;
        }
        
        .header h1 {
            font-size: 2em;
            margin-bottom: 0;
        }

        .help-button {
            position: absolute;
            right: 30px;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid white;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            font-size: 1.5em;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .help-button:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-50%) scale(1.1);
        }
        
        .controls {
            padding: 20px 30px;
            text-align: center;
            background: #f8f9fa;
        }
        
        .file-input-wrapper {
            display: inline-block;
            position: relative;
            overflow: hidden;
        }
        
        .btn {
            display: inline-block;
            padding: 15px 40px;
            font-size: 1.1em;
            font-weight: bold;
            color: white;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        input[type="file"] {
            position: absolute;
            left: 0;
            top: 0;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }
        
        .file-info {
            margin-top: 15px;
            font-size: 1em;
            color: #666;
        }
        
        .file-info.active {
            color: #667eea;
            font-weight: bold;
        }

        .title-container {
            padding: 15px 30px 0 30px;
            text-align: center;
        }

        #chartTitle {
            font-size: 1.5em;
            font-weight: bold;
            color: #333;
            padding: 10px;
            border: 2px solid transparent;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-block;
            min-width: 200px;
        }

        #chartTitle:hover {
            background: #f0f0f0;
            border-color: #667eea;
        }

        #titleInput {
            display: none;
            font-size: 1.5em;
            font-weight: bold;
            padding: 10px;
            border: 2px solid #667eea;
            border-radius: 5px;
            text-align: center;
            outline: none;
            min-width: 300px;
        }

        #titleInput.active {
            display: inline-block;
        }

        .main-content {
            display: flex;
        }

        .sidebar {
            width: 280px;
            background: #f8f9fa;
            padding: 20px;
            border-right: 1px solid #dee2e6;
            display: none;
            max-height: calc(100vh - 300px);
            overflow-y: auto;
        }

        .sidebar.active {
            display: block;
        }

        .sidebar-section {
            margin-bottom: 25px;
            padding: 15px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .sidebar-section h3 {
            font-size: 1em;
            color: #333;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 2px solid #667eea;
        }

        .hover-control {
            margin-bottom: 15px;
        }

        .hover-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-top: 10px;
        }

        .hover-button {
            padding: 8px 12px;
            border: 2px solid #667eea;
            background: white;
            color: #667eea;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            font-size: 0.85em;
            transition: all 0.3s ease;
        }

        .hover-button:hover {
            background: #f0f0ff;
        }

        .hover-button.active {
            background: #667eea;
            color: white;
        }

        .axis-control {
            margin-bottom: 15px;
        }

        .axis-control label {
            display: block;
            font-weight: bold;
            margin-bottom: 8px;
            color: #555;
            font-size: 0.95em;
        }

        .range-inputs {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .range-inputs input {
            width: 100%;
            padding: 6px 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 0.9em;
        }

        .range-inputs input::placeholder {
            color: #999;
            font-size: 0.85em;
        }

        .apply-btn {
            width: 100%;
            padding: 10px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            margin-top: 10px;
            transition: all 0.3s ease;
        }

        .apply-btn:hover {
            background: #5568d3;
        }

        .chart-container {
            flex: 1;
            min-width: 0;
            max-width: calc(100% - 300px);
        }
        
        #plotDiv {
            width: calc(100% - 20px);
            max-width: 100%;
            height: 700px;
            padding: 20px 10px 20px 20px;
        }
        
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 700px;
            color: #999;
        }
        
        .empty-state svg {
            width: 150px;
            height: 150px;
            margin-bottom: 20px;
            opacity: 0.3;
        }
        
        .empty-state p {
            font-size: 1.3em;
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
            color: #667eea;
            font-size: 1.2em;
        }
        
        .loading.active {
            display: block;
        }
        
        .error {
            display: none;
            background: #fee;
            color: #c33;
            padding: 15px;
            margin: 20px;
            border-radius: 8px;
            border-left: 4px solid #c33;
        }
        
        .error.active {
            display: block;
        }

        /* Marker è¡¨æ ¼æ¨£å¼ */
        .marker-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            background: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .marker-table th {
            background-color: #007acc;
            color: white;
            padding: 12px 8px;
            text-align: center;
            font-weight: bold;
            border: 1px solid #005a9e;
            font-size: 13px;
        }
        .marker-table td {
            padding: 10px 8px;
            border: 1px solid #ddd;
            text-align: left;
            font-size: 12px;
        }
        .marker-table tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        .marker-table tr:hover {
            background-color: #f0f8ff;
        }
        .marker-header-cell {
            font-weight: bold;
            vertical-align: middle;
        }
        .marker-delete-btn {
            padding: 4px 8px;
            background-color: #dc3545;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 11px;
        }
        .marker-delete-btn:hover {
            background-color: #c82333;
        }

        /* Marker å®¹å™¨ */
        #markerTableContainer {
            padding: 20px 30px;
            background: #f8f9fa;
            border-top: 2px solid #667eea;
        }
        #markerTableContainer h3 {
            color: #333;
            margin-bottom: 15px;
        }

        /* Modal æ¨£å¼ */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            animation: fadeIn 0.3s ease;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            background: white;
            border-radius: 15px;
            width: 90%;
            max-width: 700px;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from {
                transform: translateY(50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 30px;
            border-radius: 15px 15px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            margin: 0;
            font-size: 1.5em;
        }

        .close-button {
            background: none;
            border: none;
            color: white;
            font-size: 2em;
            cursor: pointer;
            line-height: 1;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s ease;
        }

        .close-button:hover {
            transform: rotate(90deg);
        }

        .modal-body {
            padding: 30px;
            color: #333;
            line-height: 1.8;
        }

        .help-section {
            margin-bottom: 25px;
        }

        .help-section h3 {
            color: #667eea;
            font-size: 1.2em;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .help-section p {
            margin-bottom: 10px;
            color: #555;
        }

        .help-section ul {
            margin-left: 20px;
            color: #555;
        }

        .help-section li {
            margin-bottom: 8px;
        }

        .help-section code {
            background: #f0f0f0;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
            color: #667eea;
            font-size: 0.9em;
        }

        .highlight-box {
            background: #f0f5ff;
            border-left: 4px solid #667eea;
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
        }

        .highlight-box strong {
            color: #667eea;
        }

        @media (max-width: 1024px) {
            .main-content {
                flex-direction: column;
            }
            .sidebar {
                width: 100%;
                max-width: 100%;
            }
            .chart-container {
                max-width: 100%;
            }
            .modal-content {
                width: 95%;
                max-height: 90vh;
            }
            .help-button {
                right: 15px;
                width: 35px;
                height: 35px;
                font-size: 1.3em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“Š CSV è³‡æ–™åœ–è¡¨é¡¯ç¤ºå™¨</h1>
            <button class="help-button" onclick="openHelpModal()" title="ä½¿ç”¨èªªæ˜">â“</button>
        </div>
        
        <div class="controls">
            <div class="file-input-wrapper">
                <button class="btn">ğŸ“ é¸æ“‡ CSV æª”æ¡ˆ</button>
                <input type="file" id="fileInput" accept=".csv">
            </div>
            <div class="file-info" id="fileInfo">å°šæœªé¸æ“‡æª”æ¡ˆ</div>
        </div>
        
        <div class="loading" id="loading">â³ æ­£åœ¨è¼‰å…¥è³‡æ–™...</div>
        <div class="error" id="error"></div>

        <div class="title-container">
            <div id="chartTitle" style="display: none;">åœ–è¡¨æ¨™é¡Œ (é›™æ“Šç·¨è¼¯)</div>
            <input type="text" id="titleInput" value="åœ–è¡¨æ¨™é¡Œ">
        </div>
        
        <div class="main-content">
            <div class="sidebar" id="sidebar">
                <!-- Hover æ¨¡å¼æ§åˆ¶ -->
                <div class="sidebar-section">
                    <h3>ğŸ¯ æ»‘é¼ æ‡¸åœæ¨¡å¼</h3>
                    <div class="hover-control">
                        <div class="hover-buttons">
                            <button id="hoverClosest" class="hover-button active" onclick="setHoverMode('closest')">æœ€è¿‘æ•¸æ“š</button>
                            <button id="hoverX" class="hover-button" onclick="setHoverMode('x')">X Marker</button>
                            <button id="hoverY" class="hover-button" onclick="setHoverMode('y')">Y Marker</button>
                            <button id="hoverFalse" class="hover-button" onclick="setHoverMode(false)">é—œé–‰æ‡¸åœ</button>
                        </div>
                    </div>
                </div>

                <!-- è»¸ç¯„åœè¨­å®š -->
                <div class="sidebar-section">
                    <h3>ğŸ“ è»¸ç¯„åœè¨­å®š</h3>
                    <div class="axis-control">
                        <label>X è»¸ç¯„åœ</label>
                        <div class="range-inputs">
                            <input type="text" id="xMin" placeholder="æœ€å°å€¼ (ä¾‹: 1m, 500u, 1.5n)" step="any">
                            <input type="text" id="xMax" placeholder="æœ€å¤§å€¼ (ä¾‹: 10m, 2u, 5n)" step="any">
                        </div>
                    </div>
                    <div class="axis-control">
                        <label>Y è»¸ç¯„åœ</label>
                        <div class="range-inputs">
                            <input type="number" id="yMin" placeholder="æœ€å°å€¼" step="any">
                            <input type="number" id="yMax" placeholder="æœ€å¤§å€¼" step="any">
                        </div>
                    </div>
                    <button class="apply-btn" id="applyRange">å¥—ç”¨ç¯„åœ</button>
                    <button class="apply-btn" id="resetRange" style="background: #6c757d; margin-top: 5px;">é‡è¨­ç¯„åœ</button>
                </div>

                <!-- å¦å­˜æª”æ¡ˆ -->
                <div class="sidebar-section">
                    <h3>ğŸ’¾ å¦å­˜æª”æ¡ˆ</h3>
                    <button class="apply-btn" id="saveHTML" style="background: #28a745;">å¦å­˜ç‚º HTML</button>
                    <button class="apply-btn" id="saveJPG" style="background: #17a2b8; margin-top: 5px;">å¦å­˜ç‚º JPG</button>
                    <div id="saveStatus" style="font-size: 0.85em; color: #666; margin-top: 10px; min-height: 20px;"></div>
                </div>
            </div>

            <div class="chart-container">
                <div id="plotContainer">
                    <div class="empty-state" id="emptyState">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                            <path d="M3 10h18M3 14h18"/>
                        </svg>
                        <p>è«‹é¸æ“‡ CSV æª”æ¡ˆé–‹å§‹</p>
                    </div>
                    <div id="plotDiv"></div>
                </div>
            </div>
        </div>

        <!-- Marker æ•¸å€¼è¡¨å€åŸŸ -->
        <div id="markerTableContainer" style="margin-top: 30px; border-top: 2px solid #667eea; padding-top: 20px; padding-left: 30px; padding-right: 30px; padding-bottom: 20px;">
            <h3 style="color: #333; margin-bottom: 15px;">å›ºå®š Marker æ•¸å€¼è¡¨</h3>
            
            <!-- æ‰¹é‡è¼¸å…¥ Marker å€åŸŸ -->
            <div style="background-color: #f8f9fa; padding: 15px; border-radius: 5px; margin-bottom: 20px; border: 1px solid #dee2e6;">
                <h4 style="color: #333; margin-top: 0; margin-bottom: 10px; font-size: 14px;">æ‰¹é‡æ–°å¢ Marker</h4>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <input type="text" id="batchMarkerInput" placeholder="ä¾‹å¦‚: X:10,20,30 æˆ– Y:-10,-20,-30" 
                           style="flex: 1; padding: 8px; border: 1px solid #ced4da; border-radius: 3px; font-size: 13px;">
                    <button onclick="addBatchMarkers()" style="padding: 8px 16px; background-color: #28a745; color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 13px; white-space: nowrap;">æ–°å¢ Marker</button>
                </div>
                <div style="font-size: 11px; color: #666; margin-top: 5px;">
                    æ ¼å¼èªªæ˜ï¼šè¼¸å…¥ "X:å€¼1,å€¼2,å€¼3" æ–°å¢ X Markerï¼Œæˆ– "Y:å€¼1,å€¼2,å€¼3" æ–°å¢ Y Marker
                </div>
            </div>
            
            <div id="markerTableContent" style="overflow-x: auto;">
                <div style="color: #666; font-size: 14px; padding: 20px; text-align: center;">å°šæœªæ–°å¢ä»»ä½• Marker</div>
            </div>
        </div>
    </div>

    <!-- ä½¿ç”¨èªªæ˜ Modal -->
    <div id="helpModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>ğŸ“š ä½¿ç”¨èªªæ˜</h2>
                <button class="close-button" onclick="closeHelpModal()">Ã—</button>
            </div>
            <div class="modal-body">
                <div class="help-section">
                    <h3>ğŸ“ CSV æª”æ¡ˆæ ¼å¼è¦æ±‚</h3>
                    <p>CSV æª”æ¡ˆæ‡‰åŒ…å«ï¼š</p>
                    <ul>
                        <li>ç¬¬ä¸€åˆ—ç‚ºæ¨™é¡Œåˆ—ï¼ˆè¡¨é ­ï¼‰</li>
                        <li>ç¬¬ä¸€æ¬„ç‚º X è»¸æ•¸æ“š</li>
                        <li>ä¸­é–“æ¬„ä½ç‚ºå„æ¢æ›²ç·šçš„ Y è»¸æ•¸æ“š</li>
                        <li>æœ€å¾Œä¸€æ¬„ç‚º Y è»¸çš„å–®ä½æ¨™ç±¤</li>
                    </ul>
                    <div class="highlight-box">
                        <strong>ç‰¹æ®ŠåŠŸèƒ½ï¼š</strong>å¦‚æœæ¬„ä½åç¨±åŒ…å« "spec"ï¼ˆä¸å€åˆ†å¤§å°å¯«ï¼‰ï¼Œè©²æ›²ç·šå°‡é¡¯ç¤ºç‚º<strong>æ·±ç²‰ç´…è‰²è™›ç·š</strong>
                    </div>
                </div>

                <div class="help-section">
                    <h3>ğŸ“ å›ºå®š Marker åŠŸèƒ½</h3>
                    <p><strong>é»æ“Šåœ–è¡¨</strong>å¯ä»¥å›ºå®š Marker æ¨™è¨˜ï¼š</p>
                    <ul>
                        <li><strong>æ™®é€šé»æ“Šï¼š</strong>ç§»é™¤ç¾æœ‰ marker æˆ–æ·»åŠ æ–° marker</li>
                        <li><strong>Ctrl+é»æ“Šï¼š</strong>ä¸ç§»é™¤ç¾æœ‰ markerï¼Œç›´æ¥æ·»åŠ æ–° marker</li>
                        <li><strong>X Markerï¼š</strong>ç´…è‰²å‚ç›´ç·šï¼Œé¡¯ç¤ºå„æ›²ç·šåœ¨è©² X ä½ç½®çš„ Y å€¼</li>
                        <li><strong>Y Markerï¼š</strong>è—ç¶ è‰²æ°´å¹³ç·šï¼Œé¡¯ç¤ºå„æ›²ç·šé€šéè©² Y å€¼çš„ X ä½ç½®</li>
                    </ul>
                    <div class="highlight-box">
                        <strong>æ‰¹é‡æ–°å¢ï¼š</strong>å¯åœ¨è¡¨æ ¼ä¸Šæ–¹è¼¸å…¥æ¡†ä¸­è¼¸å…¥ "X:10,20,30" æˆ– "Y:-10,-20,-30" æ‰¹é‡æ–°å¢å¤šå€‹ marker
                    </div>
                </div>

                <div class="help-section">
                    <h3>ğŸ“Š Marker æ•¸å€¼è¡¨</h3>
                    <p>å›ºå®š marker å¾Œï¼Œåº•éƒ¨æœƒé¡¯ç¤ºæ•¸å€¼è¡¨ï¼š</p>
                    <ul>
                        <li><strong>é›™æ“Šä½ç½®ï¼š</strong>å¯ä»¥ç·¨è¼¯ marker çš„ä½ç½®æ•¸å€¼</li>
                        <li><strong>æ’åºåˆ‡æ›ï¼š</strong>é»æ“Šè¡¨æ ¼æ¨™é¡Œå³å´çš„æ’åºæŒ‰éˆ•å¯åˆ‡æ›æ’åºæ¨¡å¼ï¼ˆå¤§â†’å°ã€å°â†’å¤§ã€åœ–ä¾‹é †åºï¼‰</li>
                        <li><strong>åˆªé™¤ markerï¼š</strong>é»æ“Šç´…è‰²åˆªé™¤æŒ‰éˆ•</li>
                        <li>è¡¨æ ¼é¡¯ç¤ºæ‰€æœ‰æ›²ç·šåœ¨ marker ä½ç½®çš„æ•¸å€¼</li>
                    </ul>
                </div>

                <div class="help-section">
                    <h3>ğŸ“¤ å¦‚ä½•ä¸Šå‚³æª”æ¡ˆ</h3>
                    <p>é»æ“Šã€ŒğŸ“ é¸æ“‡ CSV æª”æ¡ˆã€æŒ‰éˆ•ï¼Œé¸æ“‡æ‚¨çš„ CSV æª”æ¡ˆå³å¯è‡ªå‹•è¼‰å…¥ä¸¦ç¹ªè£½åœ–è¡¨ã€‚</p>
                </div>

                <div class="help-section">
                    <h3>âœï¸ ç·¨è¼¯åœ–è¡¨æ¨™é¡Œ</h3>
                    <p><strong>é›™æ“Š</strong>åœ–è¡¨ä¸Šæ–¹çš„æ¨™é¡Œå³å¯é€²è¡Œç·¨è¼¯ï¼ŒæŒ‰ Enter æˆ–é»æ“Šå…¶ä»–åœ°æ–¹å®Œæˆç·¨è¼¯ã€‚</p>
                </div>

                <div class="help-section">
                    <h3>ğŸ¯ æ»‘é¼ æ‡¸åœæ¨¡å¼</h3>
                    <ul>
                        <li><strong>æœ€è¿‘æ•¸æ“šï¼š</strong>é¡¯ç¤ºæ¸¸æ¨™æœ€è¿‘çš„æ•¸æ“šé»è³‡è¨Š</li>
                        <li><strong>X Markerï¼š</strong>é¡¯ç¤ºå‚ç›´åƒè€ƒç·šå’Œ Y å€¼</li>
                        <li><strong>Y Markerï¼š</strong>é¡¯ç¤ºæ°´å¹³åƒè€ƒç·šå’Œ X å€¼</li>
                        <li><strong>é—œé–‰æ‡¸åœï¼š</strong>ä¸é¡¯ç¤ºæ‡¸åœè³‡è¨Š</li>
                    </ul>
                </div>

                <div class="help-section">
                    <h3>ğŸ“ èª¿æ•´åº§æ¨™è»¸ç¯„åœ</h3>
                    <p><strong>X è»¸</strong>æ”¯æ´ SI å–®ä½å‰ç¶´è¼¸å…¥ï¼š</p>
                    <ul>
                        <li><code>G</code> = 10â¹ (Giga)</li>
                        <li><code>M</code> = 10â¶ (Mega)</li>
                        <li><code>k</code> = 10Â³ (kilo)</li>
                        <li><code>m</code> = 10â»Â³ (milli)</li>
                        <li><code>u</code> = 10â»â¶ (micro)</li>
                        <li><code>n</code> = 10â»â¹ (nano)</li>
                        <li><code>p</code> = 10â»Â¹Â² (pico)</li>
                    </ul>
                    <div class="highlight-box">
                        <strong>ç¯„ä¾‹ï¼š</strong>è¼¸å…¥ <code>1m</code> è¡¨ç¤º 0.001ï¼Œè¼¸å…¥ <code>500u</code> è¡¨ç¤º 0.0005
                    </div>
                    <p>è¼¸å…¥æ•¸å€¼å¾Œé»æ“Šã€Œå¥—ç”¨ç¯„åœã€æŒ‰éˆ•ï¼Œæˆ–é»æ“Šã€Œé‡è¨­ç¯„åœã€æ¢å¾©è‡ªå‹•èª¿æ•´ã€‚</p>
                </div>

                <div class="help-section">
                    <h3>ğŸ’¾ å„²å­˜åœ–è¡¨</h3>
                    <ul>
                        <li><strong>å¦å­˜ç‚º HTMLï¼š</strong>å°‡åœ–è¡¨å’Œç•¶å‰è¨­å®šå„²å­˜ç‚ºç¨ç«‹çš„ HTML æª”æ¡ˆï¼Œå¯ä»¥ç›´æ¥ç”¨ç€è¦½å™¨é–‹å•Ÿä¸¦ä¿ç•™äº’å‹•åŠŸèƒ½</li>
                        <li><strong>å¦å­˜ç‚º JPGï¼š</strong>å°‡åœ–è¡¨åŒ¯å‡ºç‚ºéœæ…‹åœ–ç‰‡ï¼ˆ1280x720 è§£æåº¦ï¼‰ï¼Œé©åˆå ±å‘Šæˆ–æ–‡ä»¶ä½¿ç”¨</li>
                    </ul>
                </div>

                <div class="help-section">
                    <h3>ğŸ–±ï¸ åœ–è¡¨äº’å‹•åŠŸèƒ½</h3>
                    <p>Plotly æä¾›äº†è±å¯Œçš„äº’å‹•åŠŸèƒ½ï¼š</p>
                    <ul>
                        <li><strong>ç¸®æ”¾ï¼š</strong>ç”¨æ»‘é¼ æ‹–æ›³é¸å–å€åŸŸé€²è¡Œç¸®æ”¾</li>
                        <li><strong>å¹³ç§»ï¼š</strong>æŒ‰ä½ä¸¦æ‹–æ›³åœ–è¡¨é€²è¡Œå¹³ç§»</li>
                        <li><strong>é‡è¨­è¦–åœ–ï¼š</strong>é›™æ“Šåœ–è¡¨æ¢å¾©åˆå§‹è¦–åœ–</li>
                        <li><strong>é¡¯ç¤º/éš±è—æ›²ç·šï¼š</strong>é»æ“Šå³å´åœ–ä¾‹ä¸­çš„é …ç›®</li>
                        <li><strong>å·¥å…·åˆ—ï¼š</strong>æ»‘é¼ ç§»åˆ°åœ–è¡¨ä¸Šæ–¹æœƒé¡¯ç¤ºç¸®æ”¾ã€å¹³ç§»ã€å„²å­˜ç­‰å·¥å…·</li>
                    </ul>
                </div>

                <div class="help-section">
                    <h3>ğŸ’¡ å°æç¤º</h3>
                    <ul>
                        <li>å„²å­˜çš„ HTML æª”æ¡ˆæœƒåµŒå…¥æ‰€æœ‰æ•¸æ“šå’Œè¨­å®šï¼Œå¯é›¢ç·šä½¿ç”¨</li>
                        <li>JPG åŒ¯å‡ºæœƒè‡ªå‹•åŠ ä¸Šæ‚¨è¨­å®šçš„åœ–è¡¨æ¨™é¡Œ</li>
                        <li>ä½¿ç”¨ Ctrl+é»æ“Šå¯ä»¥åŒæ™‚ä¿ç•™å¤šå€‹ marker é€²è¡Œå°æ¯”</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <script>
        const fileInput = document.getElementById('fileInput');
        const fileInfo = document.getElementById('fileInfo');
        const plotDiv = document.getElementById('plotDiv');
        const emptyState = document.getElementById('emptyState');
        const loading = document.getElementById('loading');
        const errorDiv = document.getElementById('error');
        const chartTitle = document.getElementById('chartTitle');
        const titleInput = document.getElementById('titleInput');
        const sidebar = document.getElementById('sidebar');

        // è»¸ç¯„åœè¼¸å…¥
        const xMin = document.getElementById('xMin');
        const xMax = document.getElementById('xMax');
        const yMin = document.getElementById('yMin');
        const yMax = document.getElementById('yMax');
        const applyRange = document.getElementById('applyRange');
        const resetRange = document.getElementById('resetRange');

        let currentLayout = null;
        let currentTraces = null;
        let currentConfig = null;
        let dataLoaded = false;
        let originalFileName = '';
        
        // Marker ç›¸é—œå…¨åŸŸè®Šæ•¸
        var fixedMarkers = {}; // å„²å­˜æ‰€æœ‰å›ºå®šçš„ marker
        var markerMode = 'x'; // ç•¶å‰ marker æ¨¡å¼: 'x' æˆ– 'y'
        var markerIdCounter = 0; // Marker ID è¨ˆæ•¸å™¨
        var globalSortMode = 'legend'; // å…¨åŸŸæ’åºæ¨¡å¼: 'desc', 'asc', 'legend' - é è¨­ç‚ºåœ–ä¾‹é †åº

        // Modal æ§åˆ¶å‡½æ•¸
        function openHelpModal() {
            document.getElementById('helpModal').classList.add('active');
        }

        function closeHelpModal() {
            document.getElementById('helpModal').classList.remove('active');
        }

        // é»æ“Š Modal èƒŒæ™¯é—œé–‰
        document.getElementById('helpModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeHelpModal();
            }
        });

        // ESC éµé—œé–‰ Modal
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeHelpModal();
            }
        });

        // æ¨™é¡Œç·¨è¼¯åŠŸèƒ½
        chartTitle.addEventListener('dblclick', function() {
            chartTitle.style.display = 'none';
            titleInput.classList.add('active');
            titleInput.value = chartTitle.textContent;
            titleInput.focus();
            titleInput.select();
        });

        titleInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                finishEditingTitle();
            }
        });

        titleInput.addEventListener('blur', function() {
            finishEditingTitle();
        });

        function finishEditingTitle() {
            chartTitle.textContent = titleInput.value || 'åœ–è¡¨æ¨™é¡Œ';
            chartTitle.style.display = 'inline-block';
            titleInput.classList.remove('active');
        }

        // Hover æ¨¡å¼åŠŸèƒ½
        function setHoverMode(mode) {
            // æ¸…é™¤æ‰€æœ‰æŒ‰éˆ•çš„ active ç‹€æ…‹
            document.getElementById('hoverClosest').classList.remove('active');
            document.getElementById('hoverX').classList.remove('active');
            document.getElementById('hoverY').classList.remove('active');
            document.getElementById('hoverFalse').classList.remove('active');
            
            // è¨­ç½®å°æ‡‰æŒ‰éˆ•ç‚º active ç‹€æ…‹
            if (mode === 'closest') {
                document.getElementById('hoverClosest').classList.add('active');
            } else if (mode === 'x') {
                document.getElementById('hoverX').classList.add('active');
                markerMode = 'x'; // åŒæ­¥æ›´æ–° marker æ¨¡å¼
            } else if (mode === 'y') {
                document.getElementById('hoverY').classList.add('active');
                markerMode = 'y'; // åŒæ­¥æ›´æ–° marker æ¨¡å¼
            } else {
                document.getElementById('hoverFalse').classList.add('active');
            }
            
            if (!dataLoaded || !plotDiv || !window.Plotly) return;
            
            // æ ¹æ“šæ¨¡å¼æ›´æ–° hovertemplate
            var newHoverTemplate;
            if (mode === 'x') {
                newHoverTemplate = '%{y:.6f}<extra>%{fullData.name}</extra>';
            } else if (mode === 'y') {
                newHoverTemplate = '%{x:.6f}<extra>%{fullData.name}</extra>';
            } else {
                newHoverTemplate = '<b>%{fullData.name}</b><br>X: %{x:.4f}<br>Y: %{y:.4f}<extra></extra>';
            }
            
            // æ›´æ–°æ‰€æœ‰ traces çš„ hovertemplate
            if (currentTraces && currentTraces.length > 0) {
                var traceUpdate = { hovertemplate: [] };
                for (var i = 0; i < currentTraces.length; i++) {
                    traceUpdate.hovertemplate.push(newHoverTemplate);
                }
                Plotly.restyle(plotDiv, traceUpdate);
            }
            
            // å¥—ç”¨åˆ°åœ–è¡¨
            var update = { hovermode: mode };
            
            // æ ¹æ“šæ¨¡å¼è¨­ç½® spike ç·šæ¢
            if (mode === 'x') {
                update['xaxis.showspikes'] = true;
                update['xaxis.spikemode'] = 'across';
                update['xaxis.spikesnap'] = 'cursor';
                update['xaxis.spikecolor'] = '#4ecdc4';
                update['xaxis.spikethickness'] = 2;
                update['xaxis.spikedash'] = 'solid';
                update['yaxis.showspikes'] = false;
            } else if (mode === 'y') {
                update['yaxis.showspikes'] = true;
                update['yaxis.spikemode'] = 'across';
                update['yaxis.spikesnap'] = 'cursor';
                update['yaxis.spikecolor'] = '#4ecdc4';
                update['yaxis.spikethickness'] = 2;
                update['yaxis.spikedash'] = 'solid';
                update['xaxis.showspikes'] = false;
            } else {
                update['xaxis.showspikes'] = false;
                update['yaxis.showspikes'] = false;
            }
            
            Plotly.relayout(plotDiv, update);
        }

        // å¥—ç”¨è»¸ç¯„åœ
        applyRange.addEventListener('click', () => {
            if (dataLoaded) {
                updatePlot();
            }
        });

        // é‡è¨­è»¸ç¯„åœ
        resetRange.addEventListener('click', () => {
            xMin.value = '';
            xMax.value = '';
            yMin.value = '';
            yMax.value = '';
            if (dataLoaded) {
                updatePlot();
            }
        });

        // å¦å­˜ç‚º HTML å’Œ JPG
        const saveHTMLBtn = document.getElementById('saveHTML');
        const saveJPGBtn = document.getElementById('saveJPG');
        const saveStatus = document.getElementById('saveStatus');
        
        saveHTMLBtn.addEventListener('click', () => {
            if (!dataLoaded) {
                updateSaveStatus('è«‹å…ˆè¼‰å…¥ CSV æª”æ¡ˆ');
                return;
            }
            saveAsNewHTML();
        });

        saveJPGBtn.addEventListener('click', () => {
            if (!dataLoaded) {
                updateSaveStatus('è«‹å…ˆè¼‰å…¥ CSV æª”æ¡ˆ');
                return;
            }
            saveAsJPG();
        });

        fileInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                fileInfo.textContent = `å·²é¸æ“‡: ${file.name}`;
                fileInfo.classList.add('active');
                
                const fileName = file.name.replace(/\.[^/.]+$/, '');
                originalFileName = fileName;
                titleInput.value = fileName;
                chartTitle.textContent = fileName;
                chartTitle.style.display = 'inline-block';
                
                loadAndPlotCSV(file);
            }
        });

        function loadAndPlotCSV(file) {
            loading.classList.add('active');
            errorDiv.classList.remove('active');
            emptyState.style.display = 'none';

            Papa.parse(file, {
                complete: function(results) {
                    try {
                        plotData(results.data);
                        loading.classList.remove('active');
                        sidebar.classList.add('active');
                    } catch (error) {
                        showError('è³‡æ–™è§£æéŒ¯èª¤: ' + error.message);
                        loading.classList.remove('active');
                    }
                },
                error: function(error) {
                    showError('æª”æ¡ˆè®€å–éŒ¯èª¤: ' + error.message);
                    loading.classList.remove('active');
                },
                skipEmptyLines: true,
                encoding: 'CP1252'
            });
        }

        function plotData(data) {
            if (data.length < 2) {
                throw new Error('CSV æª”æ¡ˆè³‡æ–™ä¸è¶³');
            }

            const headers = data[0].map(h => {
                let header = h.trim();
                header = header.replace(/Â£\[/g, 'Î©');
                return header;
            });
            
            const xLabel = headers[0];
            const yAxisLabel = headers[headers.length - 1];
            const yColumns = headers.slice(1, headers.length - 1);
            
            const xData = [];
            const yDataSets = yColumns.map(() => []);
            
            for (let i = 1; i < data.length; i++) {
                const row = data[i];
                if (row.length < 2) continue;
                
                const xValue = parseFloat(row[0]);
                if (!isNaN(xValue)) {
                    xData.push(xValue);
                    
                    for (let j = 0; j < yColumns.length; j++) {
                        const yValue = parseFloat(row[j + 1]);
                        yDataSets[j].push(isNaN(yValue) ? null : yValue);
                    }
                }
            }
            
            currentTraces = yColumns.map((colName, idx) => {
                const isSpec = colName.toLowerCase().includes('spec');
                
                return {
                    x: xData,
                    y: yDataSets[idx],
                    mode: 'lines',
                    name: colName,
                    line: {
                        width: 2,
                        color: isSpec ? '#FF1493' : undefined,
                        dash: isSpec ? 'dash' : 'solid'
                    },
                    hovertemplate: `<b>%{fullData.name}</b><br>X: %{x:.4f}<br>Y: %{y:.4f}<extra></extra>`
                };
            });
            
            currentLayout = {
                xaxis: {
                    title: {
                        text: xLabel,
                        font: {
                            size: 14,
                            color: '#333'
                        }
                    },
                    showgrid: true,
                    gridcolor: '#e0e0e0',
                    showspikes: false,
                    spikemode: 'across',
                    spikesnap: 'cursor',
                    spikecolor: '#4ecdc4',
                    spikethickness: 2,
                    spikedash: 'solid',
                    domain: [0, 0.95]
                },
                yaxis: {
                    title: {
                        text: yAxisLabel,
                        font: {
                            size: 14,
                            color: '#333'
                        }
                    },
                    showgrid: true,
                    gridcolor: '#e0e0e0',
                    showspikes: false,
                    spikemode: 'across',
                    spikesnap: 'cursor',
                    spikecolor: '#4ecdc4',
                    spikethickness: 2,
                    spikedash: 'solid'
                },
                hovermode: 'closest',
                showlegend: true,
                legend: {
                    x: 1.02,
                    y: 1,
                    xanchor: 'left',
                    yanchor: 'top',
                    bgcolor: 'rgba(255, 255, 255, 0.95)',
                    bordercolor: '#ddd',
                    borderwidth: 1,
                    font: {
                        size: 10,
                        family: 'Arial, sans-serif'
                    },
                    orientation: 'v',
                    traceorder: 'normal'
                },
                margin: {
                    l: 70,
                    r: 150,
                    t: 40,
                    b: 90
                },
                plot_bgcolor: '#fafafa',
                paper_bgcolor: 'white',
                autosize: true
            };
            
            currentConfig = {
                responsive: true,
                displayModeBar: 'hover',
                displaylogo: false,
                modeBarButtonsToRemove: ['lasso2d', 'select2d']
            };
            
            Plotly.newPlot(plotDiv, currentTraces, currentLayout, currentConfig).then(() => {
                dataLoaded = true;
                setupMarkerClickListeners();
            });
        }

        // ========== Marker åŠŸèƒ½é–‹å§‹ ==========
        
        // åˆ‡æ›å›ºå®š marker
        function toggleFixedMarker(x, y, ctrlKey) {
            var plotElement = document.getElementById('plotDiv');
            if (!plotElement) return;
            
            // å¦‚æœæ²’æœ‰æŒ‰ Ctrl éµï¼Œæª¢æŸ¥æ˜¯å¦éœ€è¦ç§»é™¤ç¾æœ‰çš„åŒé¡å‹ marker
            if (!ctrlKey) {
                // æ‰¾å‡ºè©²æ¨¡å¼çš„æ‰€æœ‰ marker
                var markersToRemove = [];
                for (var key in fixedMarkers) {
                    var marker = fixedMarkers[key];
                    if (marker.mode === markerMode) {
                        markersToRemove.push(marker);
                    }
                }
                
                // å¦‚æœæœ‰ç¾æœ‰çš„ markerï¼Œå…¨éƒ¨ç§»é™¤
                if (markersToRemove.length > 0) {
                    removeMultipleMarkers(markersToRemove);
                    return;
                }
            }
            
            // æ·»åŠ æ–°çš„å›ºå®š marker
            addFixedMarker(x, y, markerMode);
        }
        
        // ä¸€æ¬¡æ€§ç§»é™¤å¤šå€‹ markerï¼ˆé¿å…ç´¢å¼•å•é¡Œï¼‰
        function removeMultipleMarkers(markersToRemove) {
            var plotElement = document.getElementById('plotDiv');
            if (!plotElement || markersToRemove.length === 0) return;
            
            // æ¸…ç©ºæ‰€æœ‰ shapes å’Œ annotations
            Plotly.relayout('plotDiv', {
                shapes: [],
                annotations: []
            });
            
            // æ¸…é™¤æ‰€æœ‰ marker è¨˜éŒ„
            for (var i = 0; i < markersToRemove.length; i++) {
                delete fixedMarkers[markersToRemove[i].id];
            }
            
            // é‡æ–°æ·»åŠ å‰©é¤˜çš„ marker
            var remainingMarkers = [];
            for (var key in fixedMarkers) {
                remainingMarkers.push(fixedMarkers[key]);
            }
            
            // æ¸…ç©ºè¨˜éŒ„
            fixedMarkers = {};
            
            // é‡æ–°æ·»åŠ 
            for (var i = 0; i < remainingMarkers.length; i++) {
                var m = remainingMarkers[i];
                addFixedMarker(m.x, m.y, m.mode);
            }
            
            // æ›´æ–°è¡¨æ ¼
            updateMarkerTable();
        }
        
        // æ·»åŠ å›ºå®š marker
        function addFixedMarker(x, y, mode) {
            var plotElement = document.getElementById('plotDiv');
            if (!plotElement) return;
            
            var currentLayout = plotElement.layout;
            var shapes = currentLayout.shapes || [];
            var annotations = currentLayout.annotations || [];
            
            var originalShapesCount = shapes.length;
            var originalAnnotationsCount = annotations.length;
            
            // ç”Ÿæˆå”¯ä¸€ ID
            var markerId = 'marker_' + markerIdCounter++;
            
            // æº–å‚™æ•¸æ“šé»é™£åˆ—
            var dataPoints = [];
            
            if (mode === 'x') {
                // X Markerï¼šç´…è‰²å‚ç›´ç·š
                shapes.push({
                    type: 'line',
                    x0: x,
                    x1: x,
                    y0: 0,
                    y1: 1,
                    yref: 'paper',
                    line: {
                        color: '#ff6b6b',
                        width: 2,
                        dash: 'solid'
                    }
                });
                
                // æ·»åŠ  X åº§æ¨™æ¨™è¨»
                annotations.push({
                    x: x,
                    y: 1,
                    yref: 'paper',
                    text: 'X: ' + x.toFixed(3),
                    showarrow: false,
                    bgcolor: 'rgba(255, 107, 107, 0.8)',
                    font: { color: 'white', size: 10 },
                    xanchor: 'center',
                    yanchor: 'bottom'
                });
                
                // æ‰¾å‡ºæ‰€æœ‰æ›²ç·šåœ¨ X ä½ç½®çš„ Y å€¼
                for (var i = 0; i < currentTraces.length; i++) {
                    var trace = currentTraces[i];
                    if (trace.name.toLowerCase().includes('spec') || trace.visible === 'legendonly') {
                        continue;
                    }
                    
                    var closest = findClosestPoint(trace.x, trace.y, x, 'x');
                    if (closest) {
                        dataPoints.push({
                            name: trace.name,
                            x: closest.x,
                            y: closest.y,
                            color: trace.line.color || '#1f77b4'
                        });
                    }
                }
                
            } else {
                // Y Markerï¼šè—ç¶ è‰²æ°´å¹³ç·š
                shapes.push({
                    type: 'line',
                    x0: 0,
                    x1: 1,
                    xref: 'paper',
                    y0: y,
                    y1: y,
                    line: {
                        color: '#4ecdc4',
                        width: 2,
                        dash: 'solid'
                    }
                });
                
                // æ·»åŠ  Y åº§æ¨™æ¨™è¨»
                annotations.push({
                    x: 1,
                    xref: 'paper',
                    y: y,
                    text: 'Y: ' + y.toFixed(3),
                    showarrow: false,
                    bgcolor: 'rgba(78, 205, 196, 0.8)',
                    font: { color: 'white', size: 10 },
                    xanchor: 'left',
                    yanchor: 'middle'
                });
                
                // æ‰¾å‡ºæ‰€æœ‰æ›²ç·šé€šé Y ä½ç½®çš„ X å€¼
                for (var i = 0; i < currentTraces.length; i++) {
                    var trace = currentTraces[i];
                    if (trace.name.toLowerCase().includes('spec') || trace.visible === 'legendonly') {
                        continue;
                    }
                    
                    var closest = findClosestPoint(trace.x, trace.y, y, 'y');
                    if (closest) {
                        dataPoints.push({
                            name: trace.name,
                            x: closest.x,
                            y: closest.y,
                            color: trace.line.color || '#1f77b4'
                        });
                    }
                }
            }
            
            // æ›´æ–°åœ–è¡¨
            Plotly.relayout('plotDiv', {
                shapes: shapes,
                annotations: annotations
            });
            
            // è¨˜éŒ„å›ºå®šç‹€æ…‹
            fixedMarkers[markerId] = {
                id: markerId,
                x: x,
                y: y,
                mode: mode,
                dataPoints: dataPoints,
                shapesCount: originalShapesCount,
                annotationsCount: originalAnnotationsCount
            };
            
            // æ›´æ–°è¡¨æ ¼
            updateMarkerTable();
        }
        
        // æ‰¾æœ€æ¥è¿‘çš„é»
        function findClosestPoint(xData, yData, targetValue, axis) {
            var minDiff = Infinity;
            var closestIndex = -1;
            
            if (axis === 'x') {
                for (var i = 0; i < xData.length; i++) {
                    var diff = Math.abs(xData[i] - targetValue);
                    if (diff < minDiff) {
                        minDiff = diff;
                        closestIndex = i;
                    }
                }
            } else {
                for (var i = 0; i < yData.length; i++) {
                    var diff = Math.abs(yData[i] - targetValue);
                    if (diff < minDiff) {
                        minDiff = diff;
                        closestIndex = i;
                    }
                }
            }
            
            if (closestIndex >= 0) {
                return {
                    x: xData[closestIndex],
                    y: yData[closestIndex]
                };
            }
            return null;
        }
        
        // ç§»é™¤å–®å€‹ marker
        function removeFixedMarkerById(markerId) {
            if (!fixedMarkers[markerId]) return;
            
            var marker = fixedMarkers[markerId];
            
            // å¾è¨˜éŒ„ä¸­åˆªé™¤é€™å€‹ marker
            delete fixedMarkers[markerId];
            
            // å®Œå…¨é‡å»ºæ‰€æœ‰ marker
            rebuildPlotMarkers();
            
            // æ›´æ–°è¡¨æ ¼
            updateMarkerTable();
        }
        
        // é‡å»ºåœ–è¡¨çš„æ‰€æœ‰ marker
        function rebuildPlotMarkers() {
            var plotElement = document.getElementById('plotDiv');
            if (!plotElement) return;
            
            // æ”¶é›†æ‰€æœ‰ marker
            var allMarkers = [];
            for (var key in fixedMarkers) {
                allMarkers.push(fixedMarkers[key]);
            }
            
            // æ¸…ç©ºæ‰€æœ‰ shapes å’Œ annotations
            Plotly.relayout('plotDiv', {
                shapes: [],
                annotations: []
            });
            
            // æ¸…é™¤æ‰€æœ‰ marker è¨˜éŒ„
            fixedMarkers = {};
            
            // é‡æ–°æ·»åŠ æ‰€æœ‰ marker
            for (var i = 0; i < allMarkers.length; i++) {
                var m = allMarkers[i];
                addFixedMarker(m.x, m.y, m.mode);
            }
        }
        
        // æ›´æ–° Marker è¡¨æ ¼
        function updateMarkerTable() {
            var markerKeys = Object.keys(fixedMarkers);
            var tableContent = document.getElementById('markerTableContent');
            
            // å¦‚æœæ²’æœ‰ markerï¼Œé¡¯ç¤ºæç¤ºè¨Šæ¯
            if (markerKeys.length === 0) {
                tableContent.innerHTML = '<div style="color: #666; font-size: 14px; padding: 20px; text-align: center;">å°šæœªæ–°å¢ä»»ä½• Marker</div>';
                return;
            }
            
            // æ’åºæ¨¡å¼åœ–ç¤º
            var sortIcon = '';
            if (globalSortMode === 'desc') {
                sortIcon = 'â†“ å¤§â†’å°';
            } else if (globalSortMode === 'asc') {
                sortIcon = 'â†‘ å°â†’å¤§';
            } else {
                sortIcon = '= åœ–ä¾‹é †åº';
            }
            
            // ç”Ÿæˆè¡¨æ ¼ HTML
            var html = '';
            
            var markers = markerKeys.map(key => fixedMarkers[key]);
            
            html += '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">';
            html += '<h4 style="color: #667eea; margin: 0;">æ•¸å€¼è¡¨</h4>';
            html += '<button style="padding: 6px 12px; background-color: #17a2b8; color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 12px;" onclick="toggleGlobalSortMode()" onmouseover="this.style.backgroundColor=\'#138496\'" onmouseout="this.style.backgroundColor=\'#17a2b8\'" title="åˆ‡æ›æ’åºæ¨¡å¼">' + sortIcon + '</button>';
            html += '</div>';
            
            html += '<table class="marker-table">';
            html += '<thead><tr>';
            html += '<th style="width: 80px;">Marker</th>';
            html += '<th style="width: 100px;">ä½ç½®<br><span style="font-size: 10px; font-weight: normal;">(é›™æ“Šç·¨è¼¯)</span></th>';
            html += '<th style="width: 200px;">æ›²ç·šåç¨±</th>';
            html += '<th style="width: 120px;">æ•¸å€¼</th>';
            html += '<th style="width: 80px;">æ“ä½œ</th>';
            html += '</tr></thead><tbody>';
            
            for (var i = 0; i < markers.length; i++) {
                var marker = markers[i];
                var markerLabel = marker.mode === 'x' ? 'X Marker' : 'Y Marker';
                var markerColor = marker.mode === 'x' ? '#ff6b6b' : '#4ecdc4';
                var positionValue = marker.mode === 'x' ? marker.x.toFixed(3) : marker.y.toFixed(3);
                
                // æ ¹æ“šå…¨åŸŸæ’åºæ¨¡å¼æ’åºæ•¸æ“šé»
                var sortedDataPoints = sortDataPoints(marker.dataPoints, marker.mode, globalSortMode);
                
                for (var j = 0; j < sortedDataPoints.length; j++) {
                    var point = sortedDataPoints[j];
                    var valueToShow = marker.mode === 'x' ? point.y.toFixed(3) : point.x.toFixed(3);
                    
                    html += '<tr>';
                    if (j === 0) {
                        html += '<td rowspan="' + sortedDataPoints.length + '" class="marker-header-cell" style="background-color: ' + markerColor + '; color: white; text-align: center;">' + markerLabel + '</td>';
                        html += '<td rowspan="' + sortedDataPoints.length + '" class="marker-header-cell" style="text-align: center; cursor: pointer;" ondblclick="editMarkerPosition(\'' + marker.id + '\')" title="é›™æ“Šç·¨è¼¯ä½ç½®">' + positionValue + '</td>';
                    }
                    html += '<td style="border-left: 3px solid ' + point.color + ';">' + point.name + '</td>';
                    html += '<td style="font-family: monospace; font-weight: bold;">' + valueToShow + '</td>';
                    if (j === 0) {
                        html += '<td rowspan="' + sortedDataPoints.length + '" style="text-align: center;">';
                        html += '<button class="marker-delete-btn" onclick="removeFixedMarkerById(\'' + marker.id + '\')">åˆªé™¤</button>';
                        html += '</td>';
                    }
                    html += '</tr>';
                }
                
                // åœ¨æ¯å€‹ marker å¾Œæ·»åŠ åˆ†éš”è¡Œï¼ˆé™¤äº†æœ€å¾Œä¸€å€‹ï¼‰
                if (i < markers.length - 1) {
                    html += '<tr class="marker-separator"><td colspan="5" style="height: 3px; background-color: #333; padding: 0;"></td></tr>';
                }
            }
            
            html += '</tbody></table>';
            
            tableContent.innerHTML = html;
        }
        
        // æ ¹æ“šæ’åºæ¨¡å¼æ’åºæ•¸æ“šé»
        function sortDataPoints(dataPoints, mode, sortMode) {
            var sorted = dataPoints.slice();
            
            if (sortMode === 'desc') {
                if (mode === 'x') {
                    sorted.sort(function(a, b) { return b.y - a.y; });
                } else {
                    sorted.sort(function(a, b) { return b.x - a.x; });
                }
            } else if (sortMode === 'asc') {
                if (mode === 'x') {
                    sorted.sort(function(a, b) { return a.y - b.y; });
                } else {
                    sorted.sort(function(a, b) { return a.x - b.x; });
                }
            }
            
            return sorted;
        }
        
        // åˆ‡æ›å…¨åŸŸæ’åºæ¨¡å¼
        function toggleGlobalSortMode() {
            if (globalSortMode === 'desc') {
                globalSortMode = 'asc';
            } else if (globalSortMode === 'asc') {
                globalSortMode = 'legend';
            } else {
                globalSortMode = 'desc';
            }
            
            updateMarkerTable();
        }
        
        // ç·¨è¼¯ Marker ä½ç½®
        function editMarkerPosition(markerId) {
            var marker = fixedMarkers[markerId];
            if (!marker) return;
            
            var currentValue = marker.mode === 'x' ? marker.x : marker.y;
            var newValue = prompt('è«‹è¼¸å…¥æ–°çš„ä½ç½®å€¼ï¼š', currentValue.toFixed(3));
            
            if (newValue === null || newValue === '') return;
            
            newValue = parseFloat(newValue);
            if (isNaN(newValue)) {
                alert('è«‹è¼¸å…¥æœ‰æ•ˆçš„æ•¸å­—');
                return;
            }
            
            var mode = marker.mode;
            
            removeFixedMarkerById(markerId);
            
            if (mode === 'x') {
                addFixedMarker(newValue, 0, mode);
            } else {
                addFixedMarker(0, newValue, mode);
            }
        }
        
        // æ‰¹é‡æ–°å¢ Marker
        function addBatchMarkers() {
            var input = document.getElementById('batchMarkerInput');
            var inputValue = input.value.trim();
            
            if (!inputValue) {
                alert('è«‹è¼¸å…¥è¦æ–°å¢çš„ Marker ä½ç½®');
                return;
            }
            
            var match = inputValue.match(/^([XYxy])\s*:\s*(.+)$/);
            if (!match) {
                alert('æ ¼å¼éŒ¯èª¤ï¼è«‹ä½¿ç”¨æ ¼å¼ï¼šX:å€¼1,å€¼2,å€¼3 æˆ– Y:å€¼1,å€¼2,å€¼3');
                return;
            }
            
            var mode = match[1].toLowerCase();
            var valuesStr = match[2];
            var values = valuesStr.split(',').map(function(v) { return parseFloat(v.trim()); });
            
            var invalidValues = values.filter(function(v) { return isNaN(v); });
            if (invalidValues.length > 0) {
                alert('åŒ…å«ç„¡æ•ˆçš„æ•¸å­—å€¼');
                return;
            }
            
            for (var i = 0; i < values.length; i++) {
                if (mode === 'x') {
                    addFixedMarker(values[i], 0, 'x');
                } else {
                    addFixedMarker(0, values[i], 'y');
                }
            }
            
            input.value = '';
            alert('æˆåŠŸæ–°å¢ ' + values.length + ' å€‹ ' + mode.toUpperCase() + ' Marker');
        }
        
        // è¨­ç½®é»æ“Šäº‹ä»¶ç›£è½å™¨
        function setupMarkerClickListeners() {
            var plotElement = document.getElementById('plotDiv');
            if (!plotElement) return;
            
            plotElement.on('plotly_click', function(data) {
                if (data.points && data.points.length > 0) {
                    var point = data.points[0];
                    var x = point.x;
                    var y = point.y;
                    
                    // æª¢æ¸¬æ˜¯å¦æŒ‰ä¸‹ Ctrl éµï¼ˆæˆ– Mac çš„ Command éµï¼‰
                    var ctrlKey = data.event.ctrlKey || data.event.metaKey;
                    
                    toggleFixedMarker(x, y, ctrlKey);
                }
            });
        }
        
        // ========== Marker åŠŸèƒ½çµæŸ ==========

        // SI å–®ä½å‰ç¶´è§£æå‡½æ•¸
        function parseSIValue(input) {
            if (!input) return NaN;

            const str = input.toString().trim();

            const siPrefixes = {
                'G': 1e9,
                'M': 1e6,
                'k': 1e3,
                'm': 1e-3,
                'u': 1e-6,
                'n': 1e-9,
                'p': 1e-12
            };

            const match = str.match(/^([+-]?[\d.]+(?:e[+-]?\d+)?)\s*([GMkmunp])$/);

            if (match) {
                const number = parseFloat(match[1]);
                const prefix = match[2];

                if (!isNaN(number) && siPrefixes[prefix]) {
                    return number * siPrefixes[prefix];
                }
            }
            return parseFloat(str);
        }

        function updatePlot() {
            if (!currentLayout || !currentTraces) return;
            
            const plotElement = document.getElementById('plotDiv');
            if (!plotElement || !plotElement.layout) {
                Plotly.newPlot(plotDiv, currentTraces, currentLayout, currentConfig);
                return;
            }

            const xMinVal = parseSIValue(xMin.value);
            const xMaxVal = parseSIValue(xMax.value);
            const yMinVal = parseFloat(yMin.value);
            const yMaxVal = parseFloat(yMax.value);
            
            var updateObj = {};
            
            if (!isNaN(xMinVal) && !isNaN(xMaxVal)) {
                updateObj['xaxis.range'] = [xMinVal, xMaxVal];
                updateObj['xaxis.autorange'] = false;
            } else {
                updateObj['xaxis.autorange'] = true;
            }
            
            if (!isNaN(yMinVal) && !isNaN(yMaxVal)) {
                updateObj['yaxis.range'] = [yMinVal, yMaxVal];
                updateObj['yaxis.autorange'] = false;
            } else {
                updateObj['yaxis.autorange'] = true;
            }
            
            if (Object.keys(updateObj).length > 0) {
                Plotly.relayout(plotDiv, updateObj);
            }
        }

        function showError(message) {
            errorDiv.textContent = message;
            errorDiv.classList.add('active');
            emptyState.style.display = 'flex';
            chartTitle.style.display = 'none';
        }

        function updateSaveStatus(message) {
            if (saveStatus) {
                saveStatus.textContent = message;
                setTimeout(() => {
                    if (saveStatus.textContent === message) {
                        saveStatus.textContent = '';
                    }
                }, 3000);
            }
        }

        function saveAsJPG() {
            try {
                updateSaveStatus('æ­£åœ¨ç”Ÿæˆ JPG åœ–ç‰‡...');
                
                const timestamp = new Date().toISOString().slice(0,19).replace(/:/g,'-').replace('T','_');
                const filename = `${originalFileName || 'chart'}_${timestamp}`;
                const currentTitle = chartTitle.textContent || originalFileName || 'åœ–è¡¨';
                
                Plotly.relayout(plotDiv, {
                    'title': {
                        text: currentTitle,
                        font: {
                            size: 20,
                            color: '#333',
                            family: 'Arial, sans-serif'
                        },
                        x: 0.5,
                        xanchor: 'center'
                    }
                }).then(() => {
                    return Plotly.downloadImage(plotDiv, {
                        format: 'jpeg',
                        width: 1280,
                        height: 720,
                        filename: filename
                    });
                }).then(() => {
                    return Plotly.relayout(plotDiv, {
                        'title': null
                    });
                }).then(() => {
                    updateSaveStatus('JPG åœ–ç‰‡å·²æˆåŠŸä¿å­˜ï¼š' + filename + '.jpeg');
                }).catch((error) => {
                    updateSaveStatus('ä¿å­˜ JPG å¤±æ•—ï¼š' + error.message);
                    console.error('Error saving JPG:', error);
                    Plotly.relayout(plotDiv, {'title': null});
                });
                
            } catch (error) {
                updateSaveStatus('ä¿å­˜ JPG å¤±æ•—ï¼š' + error.message);
                console.error('Error saving JPG:', error);
            }
        }

        function saveAsNewHTML() {
            try {
                updateSaveStatus('æ­£åœ¨ç”Ÿæˆ HTML æª”æ¡ˆ...');
                
                const embeddedData = {
                    traces: currentTraces,
                    layout: currentLayout,
                    config: currentConfig,
                    fileName: originalFileName || 'åœ–è¡¨',
                    markers: fixedMarkers,
                    globalSortMode: globalSortMode,
                    markerIdCounter: markerIdCounter
                };
                
                const plotElement = document.getElementById('plotDiv');
                const embeddedRange = {
                    xaxis: {
                        range: plotElement && plotElement.layout && plotElement.layout.xaxis && plotElement.layout.xaxis.range 
                            ? plotElement.layout.xaxis.range.slice() : null,
                        autorange: plotElement && plotElement.layout && plotElement.layout.xaxis 
                            ? (plotElement.layout.xaxis.autorange !== false) : true
                    },
                    yaxis: {
                        range: plotElement && plotElement.layout && plotElement.layout.yaxis && plotElement.layout.yaxis.range 
                            ? plotElement.layout.yaxis.range.slice() : null,
                        autorange: plotElement && plotElement.layout && plotElement.layout.yaxis 
                            ? (plotElement.layout.yaxis.autorange !== false) : true
                    }
                };
                
                const newHTML = generateHTMLWithEmbeddedData(embeddedData, embeddedRange);
                
                const timestamp = new Date().toISOString().slice(0,19).replace(/:/g,'-').replace('T','_');
                const filename = `${originalFileName || 'chart'}_saved_${timestamp}.html`;
                
                const blob = new Blob([newHTML], {type: 'text/html;charset=utf-8'});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                updateSaveStatus('æª”æ¡ˆå·²æˆåŠŸä¿å­˜ï¼š' + filename);
                
            } catch (error) {
                updateSaveStatus('ä¿å­˜å¤±æ•—ï¼š' + error.message);
                console.error('Error saving HTML:', error);
            }
        }

        function generateHTMLWithEmbeddedData(embeddedData, embeddedRange) {
            try {
                const safeData = JSON.stringify(embeddedData, function(key, value) {
                    if (typeof value === 'function' || value === undefined) {
                        return null;
                    }
                    return value;
                }, 2);
                
                const safeRange = JSON.stringify(embeddedRange, function(key, value) {
                    if (typeof value === 'function' || value === undefined) {
                        return null;
                    }
                    return value;
                }, 2);
                
                let html = document.documentElement.outerHTML;
                
                html = html.replace(/\/\/ === åµŒå…¥çš„æ•¸æ“š ===[\s\S]*?\/\/ === åµŒå…¥ä»£ç¢¼çµæŸ ===\s*/g, '');
                html = html.replace(/\/\/ è‡ªå‹•è¼‰å…¥åµŒå…¥æ•¸æ“š[\s\S]*?if \(typeof embeddedChartData[^}]+}\s*/g, '');
                
                const dataScript = `
        // === åµŒå…¥çš„æ•¸æ“š ===
        let embeddedChartData = ${safeData};
        let embeddedAxisRange = ${safeRange};
        let isEmbeddedVersion = true;

        function loadEmbeddedData() {
            if (!embeddedChartData) return;
            
            try {
                currentTraces = embeddedChartData.traces;
                currentLayout = embeddedChartData.layout;
                currentConfig = embeddedChartData.config;
                originalFileName = embeddedChartData.fileName || 'åœ–è¡¨';
                
                // æ¢å¾© marker æ•¸æ“š
                if (embeddedChartData.markers) {
                    fixedMarkers = embeddedChartData.markers;
                }
                if (embeddedChartData.globalSortMode) {
                    globalSortMode = embeddedChartData.globalSortMode;
                }
                if (embeddedChartData.markerIdCounter) {
                    markerIdCounter = embeddedChartData.markerIdCounter;
                }
                
                const chartTitleElem = document.getElementById('chartTitle');
                const titleInputElem = document.getElementById('titleInput');
                if (chartTitleElem && titleInputElem) {
                    chartTitleElem.textContent = originalFileName;
                    titleInputElem.value = originalFileName;
                    chartTitleElem.style.display = 'inline-block';
                }
                
                const plotDivElem = document.getElementById('plotDiv');
                if (currentTraces && currentLayout && plotDivElem) {
                    Plotly.newPlot(plotDivElem, currentTraces, currentLayout, currentConfig).then(() => {
                        dataLoaded = true;
                        const sidebarElem = document.getElementById('sidebar');
                        const emptyStateElem = document.getElementById('emptyState');
                        if (sidebarElem) sidebarElem.classList.add('active');
                        if (emptyStateElem) emptyStateElem.style.display = 'none';
                        
                        // è¨­ç½® marker é»æ“Šç›£è½å™¨
                        setupMarkerClickListeners();
                        
                        // æ¢å¾© markers
                        if (fixedMarkers && Object.keys(fixedMarkers).length > 0) {
                            rebuildPlotMarkers();
                        }
                        
                        if (embeddedAxisRange) {
                            applyEmbeddedRange();
                        }
                        
                        const fileInfoElem = document.getElementById('fileInfo');
                        if (fileInfoElem) {
                            fileInfoElem.textContent = 'å·²è¼‰å…¥åµŒå…¥çš„åœ–è¡¨æ•¸æ“šï¼š' + originalFileName;
                            fileInfoElem.classList.add('active');
                        }
                    });
                }
                
            } catch (error) {
                console.error('è¼‰å…¥åµŒå…¥æ•¸æ“šå¤±æ•—:', error);
                if (typeof showError !== 'undefined') {
                    showError('è¼‰å…¥åµŒå…¥æ•¸æ“šå¤±æ•—ï¼š' + error.message);
                }
            }
        }

        function applyEmbeddedRange() {
            if (!embeddedAxisRange) return;
            const plotDivElem = document.getElementById('plotDiv');
            if (!plotDivElem || !window.Plotly) return;
            
            setTimeout(function() {
                try {
                    const updateObj = {};
                    const xMinElem = document.getElementById('xMin');
                    const xMaxElem = document.getElementById('xMax');
                    const yMinElem = document.getElementById('yMin');
                    const yMaxElem = document.getElementById('yMax');
                    
                    if (embeddedAxisRange.xaxis) {
                        if (!embeddedAxisRange.xaxis.autorange && embeddedAxisRange.xaxis.range) {
                            updateObj['xaxis.range'] = embeddedAxisRange.xaxis.range;
                            updateObj['xaxis.autorange'] = false;
                            
                            if (xMinElem && xMaxElem) {
                                xMinElem.value = embeddedAxisRange.xaxis.range[0].toFixed(4);
                                xMaxElem.value = embeddedAxisRange.xaxis.range[1].toFixed(4);
                            }
                        }
                    }
                    
                    if (embeddedAxisRange.yaxis) {
                        if (!embeddedAxisRange.yaxis.autorange && embeddedAxisRange.yaxis.range) {
                            updateObj['yaxis.range'] = embeddedAxisRange.yaxis.range;
                            updateObj['yaxis.autorange'] = false;
                            
                            if (yMinElem && yMaxElem) {
                                yMinElem.value = embeddedAxisRange.yaxis.range[0].toFixed(4);
                                yMaxElem.value = embeddedAxisRange.yaxis.range[1].toFixed(4);
                            }
                        }
                    }
                    
                    if (Object.keys(updateObj).length > 0) {
                        Plotly.relayout(plotDivElem, updateObj);
                    }
                    
                } catch (error) {
                    console.error('å¥—ç”¨åµŒå…¥ç¯„åœå¤±æ•—:', error);
                }
            }, 300);
        }
        
        if (typeof embeddedChartData !== 'undefined' && embeddedChartData) {
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', loadEmbeddedData);
            } else {
                loadEmbeddedData();
            }
        }
        // === åµŒå…¥ä»£ç¢¼çµæŸ ===
`;
                
                const scriptStartPattern = /(<script>\s*)(const fileInput|let currentLayout|var fixedMarkers)/;
                const match = html.match(scriptStartPattern);
                
                if (match) {
                    html = html.replace(scriptStartPattern, '$1' + dataScript + '\n        $2');
                } else {
                    console.error('æ‰¾ä¸åˆ°æ’å…¥é»');
                    throw new Error('ç„¡æ³•æ‰¾åˆ°åˆé©çš„è…³æœ¬æ’å…¥ä½ç½®');
                }
                
                return html;
                
            } catch (error) {
                console.error('ç”Ÿæˆ HTML æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
                throw error;
            }
        }
    </script>
</body>
</html>
