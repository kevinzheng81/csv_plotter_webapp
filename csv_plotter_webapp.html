<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CSV Ë≥áÊñôÂúñË°®È°ØÁ§∫</title>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2em;
            margin-bottom: 0;
        }
        
        .controls {
            padding: 20px 30px;
            text-align: center;
            background: #f8f9fa;
        }
        
        .file-input-wrapper {
            display: inline-block;
            position: relative;
            overflow: hidden;
        }
        
        .btn {
            display: inline-block;
            padding: 15px 40px;
            font-size: 1.1em;
            font-weight: bold;
            color: white;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        input[type="file"] {
            position: absolute;
            left: 0;
            top: 0;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }
        
        .file-info {
            margin-top: 15px;
            font-size: 1em;
            color: #666;
        }
        
        .file-info.active {
            color: #667eea;
            font-weight: bold;
        }

        .title-container {
            padding: 15px 30px 0 30px;
            text-align: center;
        }

        #chartTitle {
            font-size: 1.5em;
            font-weight: bold;
            color: #333;
            padding: 10px;
            border: 2px solid transparent;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-block;
            min-width: 200px;
        }

        #chartTitle:hover {
            background: #f0f0f0;
            border-color: #667eea;
        }

        #titleInput {
            display: none;
            font-size: 1.5em;
            font-weight: bold;
            padding: 10px;
            border: 2px solid #667eea;
            border-radius: 5px;
            text-align: center;
            outline: none;
            min-width: 300px;
        }

        #titleInput.active {
            display: inline-block;
        }

        .main-content {
            display: flex;
        }

        .sidebar {
            width: 280px;
            background: #f8f9fa;
            padding: 20px;
            border-right: 1px solid #dee2e6;
            display: none;
        }

        .sidebar.active {
            display: block;
        }

        .sidebar-section {
            margin-bottom: 25px;
            padding: 15px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .sidebar-section h3 {
            font-size: 1em;
            color: #333;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 2px solid #667eea;
        }

        .hover-control {
            margin-bottom: 15px;
        }

        .hover-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-top: 10px;
        }

        .hover-button {
            padding: 8px 12px;
            border: 2px solid #667eea;
            background: white;
            color: #667eea;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            font-size: 0.85em;
            transition: all 0.3s ease;
        }

        .hover-button:hover {
            background: #f0f0ff;
        }

        .hover-button.active {
            background: #667eea;
            color: white;
        }

        .axis-control {
            margin-bottom: 15px;
        }

        .axis-control label {
            display: block;
            font-weight: bold;
            margin-bottom: 8px;
            color: #555;
            font-size: 0.95em;
        }

        .range-inputs {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .range-inputs input {
            width: 100%;
            padding: 6px 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 0.9em;
        }

        .range-inputs input::placeholder {
            color: #999;
            font-size: 0.85em;
        }

        .apply-btn {
            width: 100%;
            padding: 10px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            margin-top: 10px;
            transition: all 0.3s ease;
        }

        .apply-btn:hover {
            background: #5568d3;
        }

        .chart-container {
            flex: 1;
            min-width: 0;
            max-width: calc(100% - 300px);
        }
        
        #plotDiv {
            width: calc(100% - 20px);
            max-width: 100%;
            height: 700px;
            padding: 20px 10px 20px 20px;
        }
        
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 700px;
            color: #999;
        }
        
        .empty-state svg {
            width: 150px;
            height: 150px;
            margin-bottom: 20px;
            opacity: 0.3;
        }
        
        .empty-state p {
            font-size: 1.3em;
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
            color: #667eea;
            font-size: 1.2em;
        }
        
        .loading.active {
            display: block;
        }
        
        .error {
            display: none;
            background: #fee;
            color: #c33;
            padding: 15px;
            margin: 20px;
            border-radius: 8px;
            border-left: 4px solid #c33;
        }
        
        .error.active {
            display: block;
        }

        @media (max-width: 1024px) {
            .main-content {
                flex-direction: column;
            }
            .sidebar {
                width: 100%;
                max-width: 100%;
            }
            .chart-container {
                max-width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìä CSV Ë≥áÊñôÂúñË°®È°ØÁ§∫Âô®</h1>
        </div>
        
        <div class="controls">
            <div class="file-input-wrapper">
                <button class="btn">üìÅ ÈÅ∏Êìá CSV Ê™îÊ°à</button>
                <input type="file" id="fileInput" accept=".csv">
            </div>
            <div class="file-info" id="fileInfo">Â∞öÊú™ÈÅ∏ÊìáÊ™îÊ°à</div>
        </div>
        
        <div class="loading" id="loading">‚è≥ Ê≠£Âú®ËºâÂÖ•Ë≥áÊñô...</div>
        <div class="error" id="error"></div>

        <div class="title-container">
            <div id="chartTitle" style="display: none;">ÂúñË°®Ê®ôÈ°å (ÈõôÊìäÁ∑®ËºØ)</div>
            <input type="text" id="titleInput" value="ÂúñË°®Ê®ôÈ°å">
        </div>
        
        <div class="main-content">
            <div class="sidebar" id="sidebar">
                <!-- Hover Ê®°ÂºèÊéßÂà∂ -->
                <div class="sidebar-section">
                    <h3>üéØ ÊªëÈº†Êá∏ÂÅúÊ®°Âºè</h3>
                    <div class="hover-control">
                        <div class="hover-buttons">
                            <button id="hoverClosest" class="hover-button active" onclick="setHoverMode('closest')">ÊúÄËøëÊï∏Êìö</button>
                            <button id="hoverX" class="hover-button" onclick="setHoverMode('x')">X Marker</button>
                            <button id="hoverY" class="hover-button" onclick="setHoverMode('y')">Y Marker</button>
                            <button id="hoverFalse" class="hover-button" onclick="setHoverMode(false)">ÈóúÈñâÊá∏ÂÅú</button>
                        </div>
                    </div>
                </div>

                <!-- Ëª∏ÁØÑÂúçË®≠ÂÆö -->
                <div class="sidebar-section">
                    <h3>üìè Ëª∏ÁØÑÂúçË®≠ÂÆö</h3>
                    <div class="axis-control">
                        <label>X Ëª∏ÁØÑÂúç</label>
                        <div class="range-inputs">
                            <input type="number" id="xMin" placeholder="ÊúÄÂ∞èÂÄº" step="any">
                            <input type="number" id="xMax" placeholder="ÊúÄÂ§ßÂÄº" step="any">
                        </div>
                    </div>
                    <div class="axis-control">
                        <label>Y Ëª∏ÁØÑÂúç</label>
                        <div class="range-inputs">
                            <input type="number" id="yMin" placeholder="ÊúÄÂ∞èÂÄº" step="any">
                            <input type="number" id="yMax" placeholder="ÊúÄÂ§ßÂÄº" step="any">
                        </div>
                    </div>
                    <button class="apply-btn" id="applyRange">Â•óÁî®ÁØÑÂúç</button>
                    <button class="apply-btn" id="resetRange" style="background: #6c757d; margin-top: 5px;">ÈáçË®≠ÁØÑÂúç</button>
                </div>

                <!-- Âè¶Â≠òÊ™îÊ°à -->
                <div class="sidebar-section">
                    <h3>üíæ Âè¶Â≠òÊ™îÊ°à</h3>
                    <button class="apply-btn" id="saveHTML" style="background: #28a745;">Âè¶Â≠òÁÇ∫ HTML</button>
                    <div id="saveStatus" style="font-size: 0.85em; color: #666; margin-top: 10px; min-height: 20px;"></div>
                </div>
            </div>

            <div class="chart-container">
                <div id="plotContainer">
                    <div class="empty-state" id="emptyState">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                            <path d="M3 10h18M3 14h18"/>
                        </svg>
                        <p>Ë´ãÈÅ∏Êìá CSV Ê™îÊ°àÈñãÂßã</p>
                    </div>
                    <div id="plotDiv"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const fileInput = document.getElementById('fileInput');
        const fileInfo = document.getElementById('fileInfo');
        const plotDiv = document.getElementById('plotDiv');
        const emptyState = document.getElementById('emptyState');
        const loading = document.getElementById('loading');
        const errorDiv = document.getElementById('error');
        const chartTitle = document.getElementById('chartTitle');
        const titleInput = document.getElementById('titleInput');
        const sidebar = document.getElementById('sidebar');

        // Ëª∏ÁØÑÂúçËº∏ÂÖ•
        const xMin = document.getElementById('xMin');
        const xMax = document.getElementById('xMax');
        const yMin = document.getElementById('yMin');
        const yMax = document.getElementById('yMax');
        const applyRange = document.getElementById('applyRange');
        const resetRange = document.getElementById('resetRange');

        let currentLayout = null;
        let currentTraces = null;
        let currentConfig = null;
        let dataLoaded = false;
        let originalFileName = '';
        let isEmbeddedVersion = false;

        // Ê®ôÈ°åÁ∑®ËºØÂäüËÉΩ
        chartTitle.addEventListener('dblclick', function() {
            chartTitle.style.display = 'none';
            titleInput.classList.add('active');
            titleInput.value = chartTitle.textContent;
            titleInput.focus();
            titleInput.select();
        });

        titleInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                finishEditingTitle();
            }
        });

        titleInput.addEventListener('blur', function() {
            finishEditingTitle();
        });

        function finishEditingTitle() {
            chartTitle.textContent = titleInput.value || 'ÂúñË°®Ê®ôÈ°å';
            chartTitle.style.display = 'inline-block';
            titleInput.classList.remove('active');
        }

        // Hover Ê®°ÂºèÂäüËÉΩ
        function setHoverMode(mode) {
            // Ê∏ÖÈô§ÊâÄÊúâÊåâÈàïÁöÑ active ÁãÄÊÖã
            document.getElementById('hoverClosest').classList.remove('active');
            document.getElementById('hoverX').classList.remove('active');
            document.getElementById('hoverY').classList.remove('active');
            document.getElementById('hoverFalse').classList.remove('active');
            
            // Ë®≠ÁΩÆÂ∞çÊáâÊåâÈàïÁÇ∫ active ÁãÄÊÖã
            if (mode === 'closest') {
                document.getElementById('hoverClosest').classList.add('active');
            } else if (mode === 'x') {
                document.getElementById('hoverX').classList.add('active');
            } else if (mode === 'y') {
                document.getElementById('hoverY').classList.add('active');
            } else {
                document.getElementById('hoverFalse').classList.add('active');
            }
            
            if (!dataLoaded || !plotDiv || !window.Plotly) return;
            
            // Ê†πÊìöÊ®°ÂºèÊõ¥Êñ∞ hovertemplate
            var newHoverTemplate;
            if (mode === 'x') {
                // X Marker Ê®°ÂºèÔºöÊ°ÜÂÖßÈ°ØÁ§∫ YÊï∏ÂÄºÔºåÊ°ÜÂ§ñÈ°ØÁ§∫Âúñ‰æãÂêç
                newHoverTemplate = '%{y:.6f}<extra>%{fullData.name}</extra>';
            } else if (mode === 'y') {
                // Y Marker Ê®°ÂºèÔºöÊ°ÜÂÖßÈ°ØÁ§∫ XÊï∏ÂÄºÔºåÊ°ÜÂ§ñÈ°ØÁ§∫Âúñ‰æãÂêç
                newHoverTemplate = '%{x:.6f}<extra>%{fullData.name}</extra>';
            } else {
                // ÂÖ∂‰ªñÊ®°ÂºèÔºöÈ°ØÁ§∫ÂÆåÊï¥Ë≥áË®ä
                newHoverTemplate = '<b>%{fullData.name}</b><br>X: %{x:.4f}<br>Y: %{y:.4f}<extra></extra>';
            }
            
            // Êõ¥Êñ∞ÊâÄÊúâ traces ÁöÑ hovertemplate
            if (currentTraces && currentTraces.length > 0) {
                var traceUpdate = { hovertemplate: [] };
                for (var i = 0; i < currentTraces.length; i++) {
                    traceUpdate.hovertemplate.push(newHoverTemplate);
                }
                Plotly.restyle(plotDiv, traceUpdate);
            }
            
            // Â•óÁî®Âà∞ÂúñË°®
            var update = { hovermode: mode };
            
            // Ê†πÊìöÊ®°ÂºèË®≠ÁΩÆ spike Á∑öÊ¢ù
            if (mode === 'x') {
                // X Marker Ê®°ÂºèÔºöÈ°ØÁ§∫ÂûÇÁõ¥Á∑ö
                update['xaxis.showspikes'] = true;
                update['xaxis.spikemode'] = 'across';
                update['xaxis.spikesnap'] = 'cursor';
                update['xaxis.spikecolor'] = '#4ecdc4';
                update['xaxis.spikethickness'] = 2;
                update['xaxis.spikedash'] = 'solid';
                update['yaxis.showspikes'] = false;
            } else if (mode === 'y') {
                // Y Marker Ê®°ÂºèÔºöÈ°ØÁ§∫Ê∞¥Âπ≥Á∑ö
                update['yaxis.showspikes'] = true;
                update['yaxis.spikemode'] = 'across';
                update['yaxis.spikesnap'] = 'cursor';
                update['yaxis.spikecolor'] = '#4ecdc4';
                update['yaxis.spikethickness'] = 2;
                update['yaxis.spikedash'] = 'solid';
                update['xaxis.showspikes'] = false;
            } else {
                // ÂÖ∂‰ªñÊ®°ÂºèÔºöÈóúÈñâ spike Á∑öÊ¢ù
                update['xaxis.showspikes'] = false;
                update['yaxis.showspikes'] = false;
            }
            
            Plotly.relayout(plotDiv, update);
        }

        // Â•óÁî®Ëª∏ÁØÑÂúç
        applyRange.addEventListener('click', () => {
            if (dataLoaded) {
                updatePlot();
            }
        });

        // ÈáçË®≠Ëª∏ÁØÑÂúç
        resetRange.addEventListener('click', () => {
            xMin.value = '';
            xMax.value = '';
            yMin.value = '';
            yMax.value = '';
            if (dataLoaded) {
                updatePlot();
            }
        });

        // Âè¶Â≠òÁÇ∫ HTML
        const saveHTMLBtn = document.getElementById('saveHTML');
        const saveStatus = document.getElementById('saveStatus');
        
        saveHTMLBtn.addEventListener('click', () => {
            if (!dataLoaded) {
                updateSaveStatus('Ë´ãÂÖàËºâÂÖ• CSV Ê™îÊ°à');
                return;
            }
            saveAsNewHTML();
        });

        fileInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                fileInfo.textContent = `Â∑≤ÈÅ∏Êìá: ${file.name}`;
                fileInfo.classList.add('active');
                
                const fileName = file.name.replace(/\.[^/.]+$/, '');
                originalFileName = fileName;
                titleInput.value = fileName;
                chartTitle.textContent = fileName;
                chartTitle.style.display = 'inline-block';
                
                loadAndPlotCSV(file);
            }
        });

        function loadAndPlotCSV(file) {
            loading.classList.add('active');
            errorDiv.classList.remove('active');
            emptyState.style.display = 'none';

            Papa.parse(file, {
                complete: function(results) {
                    try {
                        plotData(results.data);
                        loading.classList.remove('active');
                        sidebar.classList.add('active');
                    } catch (error) {
                        showError('Ë≥áÊñôËß£ÊûêÈåØË™§: ' + error.message);
                        loading.classList.remove('active');
                    }
                },
                error: function(error) {
                    showError('Ê™îÊ°àËÆÄÂèñÈåØË™§: ' + error.message);
                    loading.classList.remove('active');
                },
                skipEmptyLines: true,
                encoding: 'CP1252'
            });
        }

        function plotData(data) {
            if (data.length < 2) {
                throw new Error('CSV Ê™îÊ°àË≥áÊñô‰∏çË∂≥');
            }

            const headers = data[0].map(h => {
                let header = h.trim();
                header = header.replace(/¬£\[/g, 'Œ©');
                return header;
            });
            
            const xLabel = headers[0];
            const yAxisLabel = headers[headers.length - 1];
            const yColumns = headers.slice(1, headers.length - 1);
            
            const xData = [];
            const yDataSets = yColumns.map(() => []);
            
            for (let i = 1; i < data.length; i++) {
                const row = data[i];
                if (row.length < 2) continue;
                
                const xValue = parseFloat(row[0]);
                if (!isNaN(xValue)) {
                    xData.push(xValue);
                    
                    for (let j = 0; j < yColumns.length; j++) {
                        const yValue = parseFloat(row[j + 1]);
                        yDataSets[j].push(isNaN(yValue) ? null : yValue);
                    }
                }
            }
            
            currentTraces = yColumns.map((colName, idx) => ({
                x: xData,
                y: yDataSets[idx],
                mode: 'lines',
                name: colName,
                line: {
                    width: 2
                },
                hovertemplate: `<b>%{fullData.name}</b><br>X: %{x:.4f}<br>Y: %{y:.4f}<extra></extra>`
            }));
            
            currentLayout = {
                xaxis: {
                    title: {
                        text: xLabel,
                        font: {
                            size: 14,
                            color: '#333'
                        }
                    },
                    showgrid: true,
                    gridcolor: '#e0e0e0',
                    showspikes: false,
                    spikemode: 'across',
                    spikesnap: 'cursor',
                    spikecolor: '#4ecdc4',
                    spikethickness: 2,
                    spikedash: 'solid',
                    domain: [0, 0.95]
                },
                yaxis: {
                    title: {
                        text: yAxisLabel,
                        font: {
                            size: 14,
                            color: '#333'
                        }
                    },
                    showgrid: true,
                    gridcolor: '#e0e0e0',
                    showspikes: false,
                    spikemode: 'across',
                    spikesnap: 'cursor',
                    spikecolor: '#4ecdc4',
                    spikethickness: 2,
                    spikedash: 'solid'
                },
                hovermode: 'closest',
                showlegend: true,
                legend: {
                    x: 1.02,
                    y: 1,
                    xanchor: 'left',
                    yanchor: 'top',
                    bgcolor: 'rgba(255, 255, 255, 0.95)',
                    bordercolor: '#ddd',
                    borderwidth: 1,
                    font: {
                        size: 10,
                        family: 'Arial, sans-serif'
                    },
                    orientation: 'v',
                    traceorder: 'normal'
                },
                margin: {
                    l: 70,
                    r: 150,
                    t: 40,
                    b: 90
                },
                plot_bgcolor: '#fafafa',
                paper_bgcolor: 'white',
                autosize: true
            };
            
            currentConfig = {
                responsive: true,
                displayModeBar: true,
                displaylogo: false,
                modeBarButtonsToRemove: ['lasso2d', 'select2d']
            };
            
            // ‰ΩøÁî® newPlot ÂâµÂª∫ÂúñË°®
            Plotly.newPlot(plotDiv, currentTraces, currentLayout, currentConfig).then(() => {
                // ÂúñË°®ÂâµÂª∫ÂÆåÊàêÂæåË®≠ÁΩÆ
                dataLoaded = true;
            });
        }

        function updatePlot() {
            if (!currentLayout || !currentTraces) return;
            
            const plotElement = document.getElementById('plotDiv');
            if (!plotElement || !plotElement.layout) {
                // Â¶ÇÊûúÂúñË°®ÈÇÑÊ≤íÂâµÂª∫ÔºåÂÖàÂâµÂª∫ÂÆÉ
                Plotly.newPlot(plotDiv, currentTraces, currentLayout, currentConfig);
                return;
            }

            // Â•óÁî®Ëª∏ÁØÑÂúç
            const xMinVal = parseFloat(xMin.value);
            const xMaxVal = parseFloat(xMax.value);
            const yMinVal = parseFloat(yMin.value);
            const yMaxVal = parseFloat(yMax.value);
            
            var updateObj = {};
            
            if (!isNaN(xMinVal) && !isNaN(xMaxVal)) {
                updateObj['xaxis.range'] = [xMinVal, xMaxVal];
                updateObj['xaxis.autorange'] = false;
            } else {
                updateObj['xaxis.autorange'] = true;
            }
            
            if (!isNaN(yMinVal) && !isNaN(yMaxVal)) {
                updateObj['yaxis.range'] = [yMinVal, yMaxVal];
                updateObj['yaxis.autorange'] = false;
            } else {
                updateObj['yaxis.autorange'] = true;
            }
            
            if (Object.keys(updateObj).length > 0) {
                Plotly.relayout(plotDiv, updateObj);
            }
        }

        function showError(message) {
            errorDiv.textContent = message;
            errorDiv.classList.add('active');
            emptyState.style.display = 'flex';
            chartTitle.style.display = 'none';
        }

        function updateSaveStatus(message) {
            if (saveStatus) {
                saveStatus.textContent = message;
                setTimeout(() => {
                    if (saveStatus.textContent === message) {
                        saveStatus.textContent = '';
                    }
                }, 3000);
            }
        }

        function saveAsNewHTML() {
            try {
                updateSaveStatus('Ê≠£Âú®ÁîüÊàê HTML Ê™îÊ°à...');
                
                // Êî∂ÈõÜÁï∂ÂâçÊï∏Êìö
                const embeddedData = {
                    traces: currentTraces,
                    layout: currentLayout,
                    config: currentConfig,
                    fileName: originalFileName || 'ÂúñË°®'
                };
                
                // Êî∂ÈõÜÁï∂ÂâçËª∏ÁØÑÂúçË®≠ÂÆö
                const plotElement = document.getElementById('plotDiv');
                const embeddedRange = {
                    xaxis: {
                        range: plotElement && plotElement.layout && plotElement.layout.xaxis && plotElement.layout.xaxis.range 
                            ? plotElement.layout.xaxis.range.slice() : null,
                        autorange: plotElement && plotElement.layout && plotElement.layout.xaxis 
                            ? (plotElement.layout.xaxis.autorange !== false) : true
                    },
                    yaxis: {
                        range: plotElement && plotElement.layout && plotElement.layout.yaxis && plotElement.layout.yaxis.range 
                            ? plotElement.layout.yaxis.range.slice() : null,
                        autorange: plotElement && plotElement.layout && plotElement.layout.yaxis 
                            ? (plotElement.layout.yaxis.autorange !== false) : true
                    }
                };
                
                // ÁîüÊàêÊñ∞ÁöÑ HTML
                const newHTML = generateHTMLWithEmbeddedData(embeddedData, embeddedRange);
                
                // ‰∏ãËºâÊ™îÊ°à
                const timestamp = new Date().toISOString().slice(0,19).replace(/:/g,'-').replace('T','_');
                const filename = `${originalFileName || 'chart'}_saved_${timestamp}.html`;
                
                const blob = new Blob([newHTML], {type: 'text/html;charset=utf-8'});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                updateSaveStatus('Ê™îÊ°àÂ∑≤ÊàêÂäü‰øùÂ≠òÔºö' + filename);
                
            } catch (error) {
                updateSaveStatus('‰øùÂ≠òÂ§±ÊïóÔºö' + error.message);
                console.error('Error saving HTML:', error);
            }
        }

        function generateHTMLWithEmbeddedData(embeddedData, embeddedRange) {
            // ÂÆâÂÖ®Âú∞Â∫èÂàóÂåñÊï∏Êìö
            const safeData = JSON.stringify(embeddedData, function(key, value) {
                if (typeof value === 'function' || value === undefined) {
                    return null;
                }
                return value;
            }, 2);
            
            const safeRange = JSON.stringify(embeddedRange, function(key, value) {
                if (typeof value === 'function' || value === undefined) {
                    return null;
                }
                return value;
            }, 2);
            
            // Áç≤ÂèñÁï∂Ââç HTML ÂÖßÂÆπ
            let html = document.documentElement.outerHTML;
            
            // Âª∫Á´ãË¶ÅÊèíÂÖ•ÁöÑ JavaScript ‰ª£Á¢º
            const dataScript = `
        // === ÂµåÂÖ•ÁöÑÊï∏Êìö ===
        var embeddedChartData = ${safeData};
        var embeddedAxisRange = ${safeRange};
        var isEmbeddedVersion = true;

        function loadEmbeddedData() {
            if (!embeddedChartData) return;
            
            try {
                currentTraces = embeddedChartData.traces;
                currentLayout = embeddedChartData.layout;
                currentConfig = embeddedChartData.config;
                originalFileName = embeddedChartData.fileName || 'ÂúñË°®';
                
                // Ë®≠ÁΩÆÊ®ôÈ°å
                if (chartTitle && titleInput) {
                    chartTitle.textContent = originalFileName;
                    titleInput.value = originalFileName;
                    chartTitle.style.display = 'inline-block';
                }
                
                // ÂâµÂª∫ÂúñË°®
                if (currentTraces && currentLayout && plotDiv) {
                    Plotly.newPlot(plotDiv, currentTraces, currentLayout, currentConfig).then(() => {
                        dataLoaded = true;
                        sidebar.classList.add('active');
                        emptyState.style.display = 'none';
                        
                        // Â•óÁî®Ëª∏ÁØÑÂúç
                        if (embeddedAxisRange) {
                            applyEmbeddedRange();
                        }
                        
                        // Êõ¥Êñ∞ÁãÄÊÖã
                        fileInfo.textContent = 'Â∑≤ËºâÂÖ•ÂµåÂÖ•ÁöÑÂúñË°®Êï∏ÊìöÔºö' + originalFileName;
                        fileInfo.classList.add('active');
                    });
                }
                
            } catch (error) {
                console.error('ËºâÂÖ•ÂµåÂÖ•Êï∏ÊìöÂ§±Êïó:', error);
                showError('ËºâÂÖ•ÂµåÂÖ•Êï∏ÊìöÂ§±ÊïóÔºö' + error.message);
            }
        }

        function applyEmbeddedRange() {
            if (!embeddedAxisRange || !plotDiv || !window.Plotly) return;
            
            setTimeout(function() {
                try {
                    var updateObj = {};
                    
                    if (embeddedAxisRange.xaxis) {
                        if (!embeddedAxisRange.xaxis.autorange && embeddedAxisRange.xaxis.range) {
                            updateObj['xaxis.range'] = embeddedAxisRange.xaxis.range;
                            updateObj['xaxis.autorange'] = false;
                            
                            // Êõ¥Êñ∞Ëº∏ÂÖ•Ê°Ü
                            if (xMin && xMax) {
                                xMin.value = embeddedAxisRange.xaxis.range[0].toFixed(4);
                                xMax.value = embeddedAxisRange.xaxis.range[1].toFixed(4);
                            }
                        }
                    }
                    
                    if (embeddedAxisRange.yaxis) {
                        if (!embeddedAxisRange.yaxis.autorange && embeddedAxisRange.yaxis.range) {
                            updateObj['yaxis.range'] = embeddedAxisRange.yaxis.range;
                            updateObj['yaxis.autorange'] = false;
                            
                            // Êõ¥Êñ∞Ëº∏ÂÖ•Ê°Ü
                            if (yMin && yMax) {
                                yMin.value = embeddedAxisRange.yaxis.range[0].toFixed(4);
                                yMax.value = embeddedAxisRange.yaxis.range[1].toFixed(4);
                            }
                        }
                    }
                    
                    if (Object.keys(updateObj).length > 0) {
                        Plotly.relayout(plotDiv, updateObj);
                    }
                    
                } catch (error) {
                    console.error('Â•óÁî®ÂµåÂÖ•ÁØÑÂúçÂ§±Êïó:', error);
                }
            }, 300);
        }
        // === ÂµåÂÖ•‰ª£Á¢ºÁµêÊùü ===
`;
            
            // Âú® script ÈñãÂßãËôïÊèíÂÖ•Êï∏ÊìöËÖ≥Êú¨
            const scriptPattern = /(<script>\s*)(const fileInput)/;
            html = html.replace(scriptPattern, '$1' + dataScript + '\n        $2');
            
            // Âú®ËºâÂÖ•‰∫ã‰ª∂‰∏≠Ê∑ªÂä†Ëá™ÂãïËºâÂÖ•ÈÇèËºØ
            // ÊâæÂà∞ fileInput.addEventListener('change' ‰πãÂâçÔºåÊ∑ªÂä†Ê™¢Êü•
            const fileInputPattern = /(fileInput\.addEventListener\('change',)/;
            html = html.replace(fileInputPattern, 
                '// Â¶ÇÊûúÊòØÂµåÂÖ•ÁâàÊú¨ÔºåËá™ÂãïËºâÂÖ•Êï∏Êìö\n        if (typeof isEmbeddedVersion !== "undefined" && isEmbeddedVersion) {\n            loadEmbeddedData();\n        }\n\n        $1');
            
            return html;
        }
    </script>
</body>
</html>